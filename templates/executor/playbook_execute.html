<!-- templates/executor/playbook_execute.html -->

{% extends 'base/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Ejecutar Playbook en Host</h2>
    <form method="post" id="execute-form">
        {% csrf_token %}
        
        <!-- Ambiente -->
        <div class="mb-3">
            <label for="id_environment"><strong>Ambiente:</strong></label>
            {{ form.environment }}
        </div>

        <!-- Grupo -->
        <div class="mb-3">
            <label for="id_group"><strong>Grupo:</strong></label>
            {{ form.group }}
        </div>

        <!-- Host -->
        <div class="mb-3">
            <label for="id_host"><strong>Host:</strong></label>
            {{ form.host }}
        </div>

        <!-- Playbook -->
        <div class="mb-3">
            <label for="id_playbook"><strong>Playbook:</strong></label>
            {{ form.playbook }}
        </div>

        <!-- Botón de ejecución -->
        <div class="text-right mt-4">
            <button type="submit" class="btn btn-primary">Ejecutar</button>
        </div>
    </form>
</div>

<!-- Incluye jQuery si aún no lo has hecho -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    $("#id_group").prop('disabled', true);
    $("#id_host").prop('disabled', true);
    $("#id_playbook").prop('disabled', true);

    $("#id_environment").change(function(){
        var url = "{% url 'executor:load_groups' %}";
        var environmentId = $(this).val();

        $.ajax({
            url: url,
            data: {
                'environment_id': environmentId
            },
            success: function(data){
                $("#id_group").html('<option value="">---------</option>');
                $.each(data.groups, function(index, group){
                    $("#id_group").append('<option value="'+group.id+'">'+group.name+'</option>');
                });
                $("#id_group").prop('disabled', false);
                $("#id_host").html('<option value="">---------</option>').prop('disabled', true);
                $("#id_playbook").html('<option value="">---------</option>').prop('disabled', true);
            },
            error: function(xhr, status, error){
                alert("An error occurred while loading groups: " + error);
            }
        });
    });

    $("#id_group").change(function(){
        var url = "{% url 'executor:load_hosts' %}";
        var groupId = $(this).val();

        $.ajax({
            url: url,
            data: {
                'group_id': groupId
            },
            success: function(data){
                $("#id_host").html('<option value="">---------</option>');
                $.each(data.hosts, function(index, host){
                    $("#id_host").append('<option value="'+host.id+'" data-os="'+host.operating_system+'">'+host.name+'</option>');
                });
                $("#id_host").prop('disabled', false);
                $("#id_playbook").html('<option value="">---------</option>').prop('disabled', true);
            },
            error: function(xhr, status, error){
                alert("An error occurred while loading hosts: " + error);
            }
        });
    });

    $("#id_host").change(function(){
        var url = "{% url 'executor:load_playbooks' %}";
        var operatingSystem = $('#id_host option:selected').data('os');
        $.ajax({
            url: url,
            data: {
                'playbook_type': 'host',
                'operating_system': operatingSystem
            },
            success: function(data){
                $("#id_playbook").html('<option value="">---------</option>');
                $.each(data.playbooks, function(index, playbook){
                    $("#id_playbook").append('<option value="'+playbook.id+'">'+playbook.name+'</option>');
                });
                $("#id_playbook").prop('disabled', false);
            },
            error: function(xhr, status, error){
                alert("An error occurred while loading playbooks: " + error);
            }
        });
    });
});
</script>
{% endblock %}
